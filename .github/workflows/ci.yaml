name: CI

on:
    push:
        branches: ['main']
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    lint:
        name: ğŸ’„ Lint
        runs-on: blacksmith-2vcpu-ubuntu-2204
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v4

            - name: â” Setup node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: â” Set up pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 9.5.0

            - name: ğŸ“¥ Download deps
              run: pnpm install

            - name: ğŸ’„ Prettier Check
              run: pnpm prettier:check

            - name: ğŸ”¬ Lint Check
              run: pnpm lint:check

    test:
        name: ğŸ§ª Tests
        runs-on: blacksmith-2vcpu-ubuntu-2204
        needs: [lint]
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v4

            - name: â” Setup node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: â” Set up pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 9.5.0

            - name: ğŸ“¥ Download deps
              run: |
                  pnpm install
                  pnpm run build

            - name: ğŸ„ Run the tests
              run: pnpm test

    deploy:
        name: ğŸ¿ Deploy
        if: github.event_name == 'push' && ( github.ref_name == 'main' )
        runs-on: blacksmith-2vcpu-ubuntu-2204
        needs: [lint, test]
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v4

            - name: ğŸ” Install Flyctl
              uses: superfly/flyctl-actions/setup-flyctl@master

            - name: ğŸš€ Push to Fly.io
              env:
                  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
              run: flyctl deploy --remote-only --config fly-${{ github.ref_name }}.toml
